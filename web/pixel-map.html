<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Tool for turning images into map art." />
        <meta name="author" content="randypanopio & RnDMonkey" />

        <link rel="icon" type="image/png" href="images/favicon.png" />
        <link rel="icon" href="images/favicon.ico" sizes="any" />
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />

        <title>Core Keeper Pixel Mapping Tool</title>

        <!-- Bootstrap core CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />

        <!-- Main styling -->
        <link href="styles/css/main.css" rel="stylesheet" />

        <!-- Custom fonts -->
        <link
            href="https://fonts.googleapis.com/css?family=Open+Sans:300,600|Playfair+Display:400,900&display=swap"
            rel="stylesheet"
        />

        <!-- Icons -->
        <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet" />
    </head>

    <body id="page-top">
        <div id="layout">
            <!-- =====================
                 LEFT PANE
                 ===================== -->
            <aside id="left-pane">
                <div id="icon-size-container" class="d-flex align-items-center">
                    <span class="spaced">
                        <label for="icon-size-select" class="nowrap">Icon Sizes: </label>
                        <select id="icon-size-select" class="dark-text">
                            <option value="32">32 px</option>
                            <option value="48">48 px</option>
                            <option value="64" selected>64 px</option>
                        </select>
                    </span>

                    <span class="spaced">
                        <label for="cb-enable-fancy-icons">Use Images if Available: </label>
                        <input type="checkbox" id="cb-enable-fancy-icons" />
                    </span>

                    <span class="spaced">
                        <a href="contribute.html" class="btn btn-sm btn-info" target="_blank" rel="noopener noreferrer">
                            Contribute Item Images
                        </a>
                    </span>
                </div>

                <hr />

                <div id="item-selections-container">
                    <button type="button" id="btn-toggle-colors">Toggle Item Selection</button>
                    <span>Item Selections (click to disable specific items):</span>

                    <div id="item-selections" class="d-flex flex-wrap"></div>

                    <hr />

                    <button type="button" id="btn-toggle-counters">Toggle Item Counters</button>
                    <span>Counter of items for this build (click to temporarily suppress items):</span>

                    <div id="suppression-controls">
                        <span>Suppressed: <span id="suppression-count">0</span></span>
                        <button type="button" id="btn-clear-suppressed">Clear</button>
                    </div>

                    <div id="item-counters" class="d-flex flex-wrap">No Image Loaded yet!</div>
                </div>
            </aside>

            <div id="drag-bar-left" class="drag-bar"></div>

            <!-- =====================
                 MIDDLE PANE (Grid preview)
                 ===================== -->
            <section id="middle-pane">
                <div id="update-toast" class="update-toast hidden">
                    Update available. <button id="refresh-btn">Refresh</button>
                </div>

                <div class="mp-controls">
                    <span>Tile Preview: Navigation (starts from the top left)</span>
                    <span>
                        X:
                        <input type="number" class="dark-text" value="1" id="chunk-input-x" min="1" />
                    </span>
                    <span>
                        Y:
                        <input type="number" class="dark-text" value="1" id="chunk-input-y" min="1" />
                    </span>
                    <button type="button" id="btn-render-preview">Draw Grid Preview</button>
                </div>

                <div id="preview-table-container">
                    <table id="preview-table">
                        <!-- Cells inserted by script -->
                    </table>
                </div>
            </section>

            <div id="drag-bar-right" class="drag-bar"></div>

            <!-- =====================
                 RIGHT PANE
                 ===================== -->
            <section id="right-pane">
                <!-- Title -->
                <div class="rp-title">
                    Core Keeper Pixel Mapping Tool
                    <a href="about.html">
                        <i class="ri-question-fill" style="font-size: 20px"></i>
                    </a>
                </div>

                <!-- TOP: Controls -->
                <div id="rp-controls">
                    <div class="rp-row-left">
                        <span>
                            <label for="cb-enable-image-cache">Cache Image</label>
                            <input type="checkbox" id="cb-enable-image-cache" checked />
                        </span>
                        <input type="file" id="image-upload" accept="image/png, image/jpeg" />
                    </div>

                    <div class="rp-row">
                        <button type="button" id="btn-process">Process</button>

                        <span>
                            Color Match:
                            <select class="dark-text" id="process-options">
                                <option value="RGB">RGB (Fast)</option>
                                <option value="HSL">HSL Distance</option>
                                <option value="HSV">HSV Distance</option>
                                <option value="CAM16">CAM16-UCS</option>
                            </select>
                        </span>

                        <span id="cam16-weight-container" style="display: none">
                            J Factor:
                            <input
                                type="number"
                                class="dark-text"
                                value="1"
                                id="cam16-weight"
                                min="0.1"
                                max="10"
                                step="0.1"
                            />
                        </span>
                    </div>

                    <div class="rp-row">
                        <span>
                            Grid Size:
                            <input type="number" class="dark-text" value="25" id="grid-size" min="4" max="25" />
                        </span>

                        <span>
                            Grid Line Thickness:
                            <input type="number" class="dark-text" value="10" id="grid-thickness" min="1" />
                        </span>

                        <label for="show-grid-lines">Show Grid Lines</label>
                        <input type="checkbox" id="show-grid-lines" checked />
                    </div>
                </div>

                <!-- BOTTOM: Images -->
                <div id="rp-image-inputs">
                    <div class="image-block original">
                        <div class="image-header-row">
                            <button type="button" id="btn-clear-cache" class="clear-cache-btn" style="display: none">
                                Clear Cached Image
                            </button>
                            <div class="image-label">Original Image:</div>
                        </div>
                        <div class="image-content">
                            <img class="viewer-image" id="upload-preview" src="images/misc/empty.png" />
                        </div>
                    </div>

                    <div class="image-block mapped">
                        <div class="image-label">Mapped Image (click to navigate Tile Preview):</div>
                        <div class="image-content">
                            <div id="mapped-image-container">
                                <div class="contain-wrapper" id="contain-wrapper">
                                    <canvas id="output-canvas"></canvas>
                                    <canvas id="overlay-canvas"></canvas>
                                </div>
                                <div id="hover-tooltip"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress overlay -->
                <div id="progress-overlay">
                    <div id="progress-text">Loading image...</div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer>
            <div class="container text-center">
                <div class="site-footer-links">
                    <a href="https://github.com/RnDMonkey/ck-web-tools"><i class="ri-open-source-fill"></i></a>
                    <a href="https://github.com/RnDMonkey/ck-web-tools"><i class="ri-at-fill"></i></a>
                    <a href="https://github.com/RnDMonkey/ck-web-tools"><i class="ri-github-fill"></i></a>
                </div>
            </div>
        </footer>

        <!-- Bootstrap JS -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>

        <!-- Main app JS -->
        <script type="module" src="js/pixelmap.js"></script>

        <!-- Preview table creation -->
        <script>
            const tableDims = 25;
            const previewTableDOM = document.getElementById("preview-table");

            for (let y = 0; y < tableDims; y++) {
                const row = document.createElement("tr");
                row.id = `preview-row-${y}`;

                for (let x = 0; x < tableDims; x++) {
                    const cell = document.createElement("td");

                    const img = document.createElement("img");
                    img.id = `cell-${x}-${y}`;
                    img.className = "preview-cell";
                    img.style.backgroundColor = "transparent";
                    img.src = "images/misc/empty.png";
                    img.style.display = "block";

                    cell.appendChild(img);

                    // Add chunk-border classes for every 5 tiles
                    if (x % 5 === 0) cell.classList.add("chunk-left");
                    if (y % 5 === 0) cell.classList.add("chunk-top");

                    // Bold outer border
                    if (x === tableDims - 1) cell.classList.add("chunk-right");
                    if (y === tableDims - 1) cell.classList.add("chunk-bottom");

                    row.appendChild(cell);
                }
                previewTableDOM.appendChild(row);
            }
        </script>

        <!-- Panel resizing + persisted widths -->
        <script>
            const leftPane = document.getElementById("left-pane");
            const middlePane = document.getElementById("middle-pane");
            const rightPane = document.getElementById("right-pane");

            const dragLeft = document.getElementById("drag-bar-left");
            const dragRight = document.getElementById("drag-bar-right");
            const layout = document.getElementById("layout");

            let draggingLeft = false;
            let draggingRight = false;

            // Restore saved widths (in px) if any
            (function restorePaneWidths() {
                const leftWidth = Number(localStorage.getItem("cktool-left-width"));
                const rightWidth = Number(localStorage.getItem("cktool-right-width"));

                if (leftWidth > 0) {
                    leftPane.style.flexBasis = leftWidth + "px";
                }
                if (rightWidth > 0) {
                    rightPane.style.flexBasis = rightWidth + "px";
                }
                // middlePane autosizes
            })();

            dragLeft.addEventListener("mousedown", () => {
                draggingLeft = true;
                document.body.style.cursor = "ew-resize";
            });

            dragRight.addEventListener("mousedown", () => {
                draggingRight = true;
                document.body.style.cursor = "ew-resize";
            });

            window.addEventListener("mousemove", (e) => {
                if (!draggingLeft && !draggingRight) return;

                const layoutRect = layout.getBoundingClientRect();

                if (draggingLeft) {
                    const newLeft = e.clientX - layoutRect.left;
                    const clamped = Math.min(Math.max(newLeft, 250), 900);
                    leftPane.style.flexBasis = clamped + "px";
                }

                if (draggingRight) {
                    const layoutRight = layoutRect.left + layoutRect.width;
                    const newRight = layoutRight - e.clientX; // distance from mouse to right edge
                    const clamped = Math.min(Math.max(newRight, 450), 1000);
                    rightPane.style.flexBasis = clamped + "px";
                }
            });

            window.addEventListener("mouseup", () => {
                if (draggingLeft || draggingRight) {
                    const leftWidth = Math.round(leftPane.getBoundingClientRect().width);
                    const rightWidth = Math.round(rightPane.getBoundingClientRect().width);
                    localStorage.setItem("cktool-left-width", leftWidth);
                    localStorage.setItem("cktool-right-width", rightWidth);
                }

                draggingLeft = false;
                draggingRight = false;
                document.body.style.cursor = "default";
            });
        </script>
    </body>
</html>
